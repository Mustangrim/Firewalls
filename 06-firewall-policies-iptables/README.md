# Linux IPTables Firewall Configuration Lab

## Lab Overview

**Lab Focus:** Advanced Linux iptables firewall configuration and network security implementation  
**Difficulty:** Advanced    
**Author:** Mykyta Palamarchuk  
**Role:** SOC Analyst | Incident Response Specialist  
**Certification:** CompTIA Security+ (SY0-701)

### Environment Specifications
- **Platform:** Linux with iptables stateful firewall
- **Network Architecture:** Multi-zone design (WAN/LAN/DMZ)
- **Business Context:** Startup company web application hosting
- **Technology Focus:** Command-line firewall administration and packet filtering

---

## Learning Objectives

Upon completion of this lab, participants will be able to:

1. **Understand iptables architecture** including tables, chains, and rules hierarchy
2. **Configure stateful packet filtering** using advanced matching criteria and connection states
3. **Implement Network Address Translation (NAT)** for service publishing and internet access
4. **Design multi-zone network security** with appropriate access controls between network segments
5. **Troubleshoot network connectivity issues** using iptables analysis and testing techniques
6. **Apply Linux firewall best practices** for enterprise security implementations
7. **Validate firewall configurations** through systematic testing and verification procedures

---

## Business Scenario

### Startup Company Challenge
Your web developer friend has recently established a startup company developing the "Vacation Planner" web application. The company is currently small but expects rapid growth and has decided to host their application on their own infrastructure for cost control and customization flexibility.

**Current Infrastructure:**
- **DMZ:** Web server hosting the Vacation Planner application
- **LAN:** Desktop computers and employee laptops for development work
- **WAN:** Internet connection with static public IP address
- **Management:** Separate interface for administrative access

**Security Requirements:**
- **Web Application Access:** Public access to vacation-planner.lab from internet
- **Employee Internet Access:** Secure internet connectivity for productivity
- **Network Segmentation:** Proper isolation between DMZ and LAN
- **Remote Administration:** SSH access for firewall management

---

## IPTables Architecture Foundation

### Linux Firewall Technology
IPTables is a stateful software firewall included with most Linux distributions by default. It provides powerful packet filtering and routing capabilities through a structured approach using tables, chains, and rules.

**Key Advantages:**
- **Stateful Connection Tracking:** Advanced connection state management
- **Flexible Rule Structure:** Granular control over packet processing
- **High Performance:** Kernel-level packet processing
- **Cost Effective:** No licensing costs for enterprise deployments

### Tables, Chains, and Rules Hierarchy

#### Tables Organization
IPTables organizes functionality into three main tables:

**1. Filter Table (Default):**
- **Purpose:** Packet filtering and firewalling functionality
- **Usage:** Default table when no table is specified
- **Function:** Accept, drop, or reject network packets

**2. NAT Table:**
- **Purpose:** Network Address Translation for routing
- **Usage:** Alter source or destination addresses
- **Function:** Enable internet access and service publishing

**3. Mangle Table:**
- **Purpose:** Packet header modification for special cases
- **Usage:** Advanced traffic shaping and marking
- **Function:** QoS, rate limiting, and statistical collection

#### Chain Structure

**Filter Table Chains:**
- **INPUT:** Evaluates packets addressed to the firewall machine
- **FORWARD:** Evaluates packets traveling through the firewall machine
- **OUTPUT:** Evaluates packets originating from the firewall machine

**NAT Table Chains:**
- **PREROUTING:** Alters packets before routing decisions (DNAT)
- **OUTPUT:** Alters packets generated by firewall before routing
- **POSTROUTING:** Alters packets after routing decisions (SNAT)

![IPTables Packet Flow](https://raw.githubusercontent.com/Mustangrim/Firewalls/main/assets/screenshots/iptables-packet-flow.png)

#### Rules Processing Logic
**Sequential Evaluation:**
1. Packets evaluated against rules in order from top to bottom
2. **First match wins** - processing stops when criteria are met
3. **Default policy applied** if no rules match packet characteristics
4. **Target execution** - specified action taken when rule matches

---

## Knowledge Assessment

### Tables and Chains Understanding

**Question 1:** You want to redirect incoming HTTP/HTTPS requests to the web server in DMZ. In which table do you need to make the change?

**✅ Answer:** `NAT`

**Rationale:** NAT table handles address translation for incoming traffic redirection through PREROUTING chain.

**Question 2:** You want to block SSH connections made to your Firewall machine. In which table do you need to make the change?

**✅ Answer:** `Filter`

**Rationale:** Filter table's INPUT chain controls traffic addressed to the firewall machine itself.

### Chain Selection Analysis

**Question 1:** Employees on LAN interface requested internet access. You want to allow connections from LAN interface to WAN interface. In which chain of FILTER table would you make changes?

**✅ Answer:** `FORWARD`

**Rationale:** FORWARD chain handles packets traveling through the firewall between different network interfaces.

**Question 2:** You want to block or allow SSH connections to your Firewall machine. In which chain of FILTER table would you make changes?

**✅ Answer:** `INPUT`

**Rationale:** INPUT chain processes packets addressed directly to the firewall machine.

**Question 3:** You want to redirect HTTP/HTTPS requests addressed to Firewall machine to a Web Server located on DMZ. In which chain of NAT table would you make changes?

**✅ Answer:** `PREROUTING`

**Rationale:** PREROUTING chain handles destination address translation before routing decisions.

### Rule Configuration Parameters

**Question 1:** Which --state attribute values do you need to use if you want only connections associated with an established connection or part of an existing connection to be forwarded?

**✅ Answer:** `ESTABLISHED,RELATED`

**Explanation:**
- **ESTABLISHED:** Packets that are part of an existing connection
- **RELATED:** Packets associated with an established connection (e.g., FTP data channels)

**Question 2:** If you wanted to send SSH connections coming to port 2221 to machine with 10.0.2.2 IP address, what would the --dport attribute value be?

**✅ Answer:** `2221`

**Explanation:** The --dport parameter specifies the destination port that triggers the rule action.

---

## Lab Environment Access

### System Credentials and Access Methods

**Web Interface Access:**
- **URL:** `mgmt-firewall:8080`
- **Username:** `student`
- **Password:** `student`

**SSH Command Line Access:**
- **Hostname:** `mgmt-firewall`
- **Username:** `student`
- **Password:** `student`

**Network Interface Configuration:**
- **enp1s7:** WAN interface (Internet connection)
- **enp1s8:** LAN interface (Internal network)
- **enp1s6:** DMZ interface (Web server network)
- **enp1s9:** Management interface (Administrative access)

### Important Security Notes

**Management Interface Rule:**
```bash
# DO NOT MODIFY - Enables administrative access
iptables -A INPUT -i enp1s9 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
```

**Default Rules Management:**
- **Web Interface:** Use "Load" button to restore defaults
- **Script Location:** `/home/student/default_fw_rules.sh`
- **Reset Command:** `sudo bash /home/student/default_fw_rules.sh`

---

## Lab Exercises

### Exercise 1: Basic INPUT Chain Configuration

**Scenario:** Configure fundamental input traffic rules to secure the firewall machine while maintaining necessary administrative access and web interface functionality.

#### Objective
Establish baseline security controls for traffic addressed to the firewall machine itself, including management interface access and web administration.

#### Implementation Requirements

**1. Configure Loopback Interface Access:**
```bash
sudo iptables -A INPUT -i lo -j ACCEPT
```
**Purpose:** Allow internal system communication

**2. Enable Stateful Connection Tracking:**
```bash
sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
```
**Purpose:** Allow return traffic for established connections

**3. Configure Web Interface Access:**
```bash
sudo iptables -A INPUT -i enp1s7 -p tcp --dport 8080 -j ACCEPT
sudo iptables -A INPUT -i enp1s8 -p tcp --dport 8080 -j ACCEPT
```
**Purpose:** Enable web-based firewall management from WAN and LAN

**4. Save Configuration:**
```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4 > /dev/null
```

#### Validation Procedures
**1. Verify Rules Application:**
```bash
sudo iptables -L INPUT -v
```

**2. Test Web Interface Access:**
- Navigate to `mgmt-firewall:8080` from different network segments
- Confirm management functionality is preserved

---

### Exercise 2: HTTP/HTTPS Service Publishing Configuration

**Scenario:** The vacation planner web application must be accessible from the internet using the domain name vacation-planner.lab. Configure NAT rules to redirect incoming web traffic to the DMZ web server.

#### Objective
Implement Network Address Translation (NAT) to publish internal web services to external users while maintaining network security through proper traffic redirection.

#### Business Requirements
- **Domain:** vacation-planner.lab points to firewall's public IP
- **Services:** HTTP (port 80) and HTTPS (port 443) access required
- **Target:** Web server at 10.0.3.2 in DMZ network
- **Security:** Maintain network segmentation while enabling public access

#### NAT Configuration Implementation

**1. Configure HTTP Traffic Redirection:**
```bash
sudo iptables -t nat -A PREROUTING -i enp1s7 -p tcp --dport 80 -j DNAT --to-destination 10.0.3.2:80
```

**2. Configure HTTPS Traffic Redirection:**
```bash
sudo iptables -t nat -A PREROUTING -i enp1s7 -p tcp --dport 443 -j DNAT --to-destination 10.0.3.2:443
```

**3. Configure Source NAT for Return Traffic:**
```bash
sudo iptables -t nat -A POSTROUTING -o enp1s7 -j SNAT --to-source 10.0.1.1
```

**Technical Explanation:**
- **PREROUTING DNAT:** Changes destination IP from firewall to web server
- **POSTROUTING SNAT:** Ensures return traffic routes correctly through firewall
- **Interface Specification:** Restricts rules to WAN interface traffic only

#### Validation and Testing

**1. Test HTTP Connectivity:**
```bash
curl http://vacation-planner.lab
```

**2. Test HTTPS Connectivity:**
```bash
curl https://vacation-planner.lab
```

**3. Save NAT Configuration:**
```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4 > /dev/null
```

#### Expected Results
- **Successful Connection:** Web application accessible from internet
- **Proper Redirection:** Traffic transparently forwarded to DMZ server
- **Security Maintained:** DMZ server not directly exposed to internet

---

### Exercise 3: LAN and DMZ Access Control Configuration

**Scenario:** Employees require internet access for productivity, but DMZ servers should be restricted from initiating outbound connections to maintain security isolation. Configure FORWARD chain rules to implement appropriate network segmentation.

#### Objective
Design and implement network segmentation policies that balance business functionality with security requirements through granular traffic control between network zones.

#### Security Requirements
- **LAN Internet Access:** Employees must access internet for business purposes
- **DMZ Isolation:** DMZ servers cannot initiate new connections to internet or LAN
- **Existing Connections:** Maintain established connections for ongoing communications
- **WAN to LAN Protection:** Prevent unauthorized access from internet to internal network

#### FORWARD Chain Configuration

**1. Enable LAN to Internet Access:**
```bash
# Allow new outbound connections from LAN to WAN
sudo iptables -A FORWARD -i enp1s8 -o enp1s7 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT

# Allow return traffic from WAN to LAN for established connections
sudo iptables -A FORWARD -i enp1s7 -o enp1s8 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

**2. Restrict DMZ Outbound Access:**
```bash
# Block new connections from DMZ to LAN
sudo iptables -A FORWARD -i enp1s6 -o enp1s8 -m state --state NEW -j DROP

# Block new connections from DMZ to WAN  
sudo iptables -A FORWARD -i enp1s6 -o enp1s7 -m state --state NEW -j DROP
```

#### Connection State Analysis

**State Matching Explanation:**
- **NEW:** First packet of a new connection
- **ESTABLISHED:** Packets belonging to existing connections
- **RELATED:** Packets related to established connections (e.g., FTP data channels)

**Security Benefits:**
- **Stateful Filtering:** Automatic handling of return traffic
- **Connection Tracking:** Enhanced security through session awareness
- **Granular Control:** Different policies for different connection states

#### Network Testing and Validation

**1. Test LAN Internet Connectivity:**
```bash
# From LAN machine, test internet access
ping 8.8.8.8
curl http://example.com
```

**2. Verify DMZ Isolation:**
```bash
# From DMZ machine, confirm outbound restrictions
ping 8.8.8.8  # Should fail
curl http://example.com  # Should fail
```

**3. Save FORWARD Rules:**
```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4 > /dev/null
```

#### Expected Network Behavior
- **LAN Users:** Full bidirectional internet access
- **DMZ Servers:** Inbound service access only, no outbound initiation
- **Security Posture:** Enhanced through network segmentation

---

### Exercise 4: SSH Remote Administration Configuration

**Scenario:** Enable secure remote administration capabilities for firewall management from both internal network and internet while maintaining appropriate security controls.

#### Objective
Configure SSH access to the firewall machine to support remote administration requirements while balancing security and operational needs.

#### Business Justification
- **Remote Management:** Enable administration without physical access
- **Operational Efficiency:** Support distributed team management capabilities
- **Emergency Access:** Ensure connectivity during critical situations
- **Security Maintenance:** Facilitate timely security updates and configuration changes

#### SSH Access Configuration

**1. Enable SSH Access from Internet:**
```bash
sudo iptables -A INPUT -p tcp -i enp1s7 --dport 22 -j ACCEPT
```

**2. Enable SSH Access from Internal LAN:**
```bash
sudo iptables -A INPUT -p tcp -i enp1s8 --dport 22 -j ACCEPT
```

#### Security Considerations

**Risk Assessment:**
- **Internet SSH Access:** Increased attack surface from external threats
- **Mitigation Strategies:** Key-based authentication, fail2ban, non-standard ports
- **Monitoring Requirements:** Enhanced logging and alerting for SSH activities

**Best Practices Implementation:**
- **Strong Authentication:** Disable password authentication, use SSH keys
- **Rate Limiting:** Implement connection rate limiting to prevent brute force
- **Log Monitoring:** Comprehensive logging of SSH access attempts
- **Network Segmentation:** Limit SSH access to specific source networks when possible

#### Configuration Persistence

**1. Save SSH Configuration:**
```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4 > /dev/null
```

**2. Verify SSH Accessibility:**
```bash
# Test SSH connection from appropriate network segments
ssh student@<firewall-ip>
```

#### Operational Validation
- **Internal Access:** SSH connectivity from LAN workstations
- **External Access:** SSH connectivity from internet (with appropriate security measures)
- **Functionality Testing:** Confirm administrative capabilities through SSH sessions

---

## Advanced IPTables Concepts

### Stateful Firewall Benefits

**Connection State Tracking:**
- **Enhanced Security:** Automatic handling of return traffic without broad rules
- **Performance Optimization:** Efficient packet processing through connection tables
- **Protocol Awareness:** Deep understanding of connection-oriented and connectionless protocols
- **Attack Prevention:** Protection against connection hijacking and spoofing attempts

### Network Address Translation (NAT) Architecture

**DNAT (Destination NAT):**
- **Service Publishing:** Enable external access to internal services
- **Load Balancing:** Distribute traffic across multiple backend servers
- **Port Redirection:** Change destination ports for security or convenience

**SNAT (Source NAT):**
- **Internet Access:** Enable internal hosts to access external resources
- **IP Conservation:** Multiple internal hosts share single public IP
- **Return Traffic:** Ensure proper routing of response packets

### Rule Optimization Strategies

**Performance Considerations:**
- **Rule Ordering:** Place frequently matched rules higher in chains
- **Specific Matching:** Use specific criteria to minimize processing overhead  
- **Connection State:** Leverage stateful matching for efficiency
- **Jump Targets:** Use custom chains for complex rule sets

---

## Troubleshooting and Maintenance

### Common Configuration Issues

**1. Rule Ordering Problems:**
- **Symptom:** Unexpected traffic blocking or allowing
- **Solution:** Review rule sequence and reorder appropriately
- **Prevention:** Plan rule structure before implementation

**2. NAT Configuration Errors:**
- **Symptom:** Services unreachable from external networks
- **Solution:** Verify PREROUTING and POSTROUTING rule pairs
- **Prevention:** Test NAT rules systematically after creation

**3. State Tracking Issues:**
- **Symptom:** Established connections suddenly dropping
- **Solution:** Check connection tracking table capacity and timeouts
- **Prevention:** Monitor connection table utilization

### Diagnostic Commands and Techniques

**Rule Analysis:**
```bash
# List all rules with packet counters
sudo iptables -L -v -n

# List NAT table rules
sudo iptables -t nat -L -v -n

# Show connection tracking table
sudo cat /proc/net/nf_conntrack
```

**Traffic Testing:**
```bash
# Test connectivity from different interfaces
ping -I <interface> <destination>

# Trace packet path through iptables
iptables -t raw -A PREROUTING -p icmp -j TRACE
```

**Log Analysis:**
```bash
# Monitor iptables logs
sudo tail -f /var/log/syslog | grep iptables

# Analyze connection patterns
sudo netstat -tuln
```

---

## Security Best Practices

### Defense in Depth Implementation

**Layered Security Approach:**
1. **Network Segmentation:** Isolate different security zones
2. **Stateful Filtering:** Track connection states for enhanced security
3. **Service Hardening:** Secure individual services beyond firewall
4. **Monitoring and Alerting:** Continuous security posture assessment

### Configuration Management

**Version Control:**
- **Rule Documentation:** Maintain detailed documentation of rule purposes
- **Change Management:** Implement approval processes for rule modifications
- **Backup Procedures:** Regular backup of working configurations
- **Testing Protocols:** Validate changes in test environments first

### Compliance Considerations

**Regulatory Requirements:**
- **Logging Standards:** Comprehensive audit trails for compliance
- **Access Controls:** Documented justification for network access rules
- **Regular Reviews:** Periodic assessment of rule necessity and effectiveness
- **Change Documentation:** Detailed records of security control modifications

---

## Lab Summary

This comprehensive IPTables lab demonstrates advanced Linux firewall configuration techniques essential for enterprise network security. The hands-on approach builds practical skills in stateful packet filtering, network address translation, and multi-zone security architecture design.

**Key Technical Achievements:**
- **Stateful Firewall Configuration:** Advanced connection state management and filtering
- **NAT Implementation:** Service publishing and internet access through address translation
- **Network Segmentation:** Multi-zone security architecture with appropriate isolation controls
- **Remote Administration:** Secure SSH access configuration with security considerations
- **Systematic Validation:** Comprehensive testing procedures for configuration verification

**Real-World Applications:**
- **Linux Server Hardening:** Enterprise server security implementations
- **Cloud Infrastructure:** AWS/Azure Linux instance security configuration
- **Container Security:** Docker and Kubernetes network policy implementation
- **Edge Computing:** IoT and edge device firewall configuration
- **DevOps Integration:** Infrastructure-as-code firewall management

**Career Development Value:**
- **Linux Administration:** Essential command-line firewall management skills
- **Network Security:** Deep understanding of packet filtering and network controls
- **System Integration:** Ability to integrate firewall controls with business applications
- **Troubleshooting Expertise:** Systematic approach to network connectivity diagnosis
- **Security Architecture:** Understanding of defense-in-depth security principles

---

*This advanced lab builds essential skills for security professionals working with Linux-based network security implementations. The concepts and configurations demonstrated here directly support enterprise security operations, cloud deployments, and modern infrastructure security requirements.*
